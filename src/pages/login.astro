---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
---

<Layout>
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <div class="flex justify-center mb-6">
            <img src="/plm-logo.png" alt="PLM Logo" class="h-24 w-auto" />
        </div>

        <h1 class="text-2xl font-bold text-center text-blue-900 mb-6">Student Portal</h1>

        <form id="loginForm" class="flex flex-col gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Email</label>
                <input type="email" id="email" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-800 outline-none" required />
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Password</label>
                <input type="password" id="password" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-800 outline-none" required />
            </div>

            <button type="submit" class="bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 transition">
                Sign In
            </button>
        </form>
        <p id="error" class="text-red-600 text-sm text-center mt-4 hidden"></p>
    </div>
</Layout>

<script>
    import { apiRequest } from "../lib/api.ts";

    const form = document.getElementById("loginForm");
    const errorMsg = document.getElementById("error");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = (document.getElementById("email") as HTMLInputElement).value;
        const password = (document.getElementById("password") as HTMLInputElement).value;

        // --- Core Login Logic ---
        try {
            const data = await apiRequest("/auth/login", "POST", { email, password });

            // CRITICAL FIX: Ensure data.payload exists before accessing properties
            if (data.payload && data.payload.token) {

                // Store the necessary items from the nested payload
                localStorage.setItem("jwt_token", data.payload.token);
                localStorage.setItem("account_id", data.payload.accountId);

                // Store the full profile for the dashboard, which requires JSON.stringify
                localStorage.setItem("user_profile", JSON.stringify(data.payload.profile));

                window.location.href = "/dashboard";
            } else {
                throw new Error(data.message || "Invalid credentials");
            }
        } catch (err: any) {
            if(errorMsg) {
                errorMsg.innerText = "Login Failed: " + (err.message || "Unknown error");
                errorMsg.classList.remove("hidden");
            }
        }
    });
</script>