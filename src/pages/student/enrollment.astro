---
import "../../styles/global.css";
import Header from "../../components/Header.astro";
import StudentNavigation from "../../components/navigations/StudentNavigation.astro";
import EnrollmentView from "../../components/student/EnrollmentView.astro";

// Auth Guard
const tokenCookie = Astro.cookies.get('jwt_token');
if (!tokenCookie?.value) return Astro.redirect('/');

// Get User Profile
let userProfile: any = {};
try {
    const profileCookie = Astro.cookies.get('user_profile');
    if (profileCookie?.value) userProfile = JSON.parse(atob(profileCookie.value));
} catch (e) {}

// --- ROBUST NAME PARSING ---
let firstName = "";
let lastName = "";

const fullName = userProfile.student_name || userProfile.name || userProfile.professor_name;

if (fullName && fullName.includes(',')) {
    // Format: "Lastname, Firstname M."
    const parts = fullName.split(',');
    lastName = parts[0].trim();

    const rest = parts[1].trim();
    const nameParts = rest.split(' ');

    if (nameParts.length > 1 && (nameParts[nameParts.length-1].endsWith('.') || nameParts[nameParts.length-1].length === 1)) {
        nameParts.pop();
        firstName = nameParts.join(' ');
    } else {
        firstName = rest;
    }
} else {
    firstName = userProfile.firstName || userProfile.first_name || "Student";
    lastName = userProfile.lastName || userProfile.last_name || "User";
}

const studentId = userProfile.studentNo || userProfile.student_no || "N/A";
const displayName = `${firstName} ${lastName}`; // Combine for the view title
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Enrollment</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans text-gray-800">
<Header firstName={firstName} lastName={lastName} studentId={studentId.toString()} />
<StudentNavigation />
<main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-8">
    <!-- Pass the parsed full name to the view -->
    <EnrollmentView studentName={displayName} />
</main>
</body>
</html>