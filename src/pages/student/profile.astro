---
import "../../styles/global.css";
import Header from "../../components/Header.astro";
import StudentNavigation from "../../components/navigations/StudentNavigation.astro";

const tokenCookie = Astro.cookies.get('jwt_token');
if (!tokenCookie?.value) return Astro.redirect('/');

let userProfile: any = {};
try {
    const profileCookie = Astro.cookies.get('user_profile');
    if (profileCookie?.value) {
        userProfile = JSON.parse(atob(profileCookie.value));
    }
} catch (e) {
    console.error("Failed to parse profile cookie");
}

// --- ROBUST NAME PARSING (Extracting Last, First, Middle) ---
let firstName = "";
let lastName = "";
let middleName = "";

// Check "student_name" or "name" (Format: "Last, First Middle")
const compositeName = userProfile.student_name || userProfile.name || userProfile.professor_name;

if (compositeName && compositeName.includes(',')) {
    const parts = compositeName.split(',');
    lastName = parts[0].trim();

    const rest = parts[1].trim(); // "Firstname Middle."
    const nameParts = rest.split(' ');

    // Check if the last part looks like a Middle Initial/Name
    if (nameParts.length > 1 && (nameParts[nameParts.length-1].endsWith('.') || nameParts[nameParts.length-1].length === 1)) {
        middleName = nameParts.pop(); // Remove and store middle
        firstName = nameParts.join(' '); // Remaining is First Name
    } else {
        firstName = rest;
        middleName = "-"; // Explicitly empty
    }
} else {
    // Fallback if not comma-separated
    firstName = userProfile.first_name || userProfile.firstName || "Student";
    lastName = userProfile.last_name || userProfile.lastName || "";
    middleName = userProfile.middle_name || userProfile.middleName || "-";
}

// Extract other fields with better defaults
const studentId = userProfile.studentNo || userProfile.student_no || "N/A";
const email = userProfile.email || "N/A";

// Note: If courseCode is missing from login response, we might need a separate fetch,
// but for now, we display "Not Assigned" instead of just "N/A" to be clearer.
const courseCode = userProfile.courseCode || userProfile.course_code || "Not Assigned";
const yearLevel = userProfile.yearLevel || userProfile.year_level || "1";
const studentType = userProfile.studentType || userProfile.student_type || "REGULAR";
const educationLevel = userProfile.educationLevel || userProfile.education_level || "UNDERGRADUATE";
const studentStatus = userProfile.studentStatus || userProfile.student_status || "ADMITTED";
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans text-gray-800">
<!-- Header uses parsed values -->
<Header firstName={firstName} lastName={lastName} studentId={studentId.toString()} />
<StudentNavigation />
<main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-8">
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-200">
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <h1 class="text-2xl font-bold text-plm-navy">Personal Information</h1>
            <span class={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${
                studentStatus === 'ENROLLED' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-gray-100 text-gray-600 border-gray-200'
            }`}>
                    {studentStatus}
                </span>
        </div>

        <div class="space-y-8">
            <!-- ID & Contact -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Student No.</label>
                    <p class="text-lg font-medium text-gray-900 font-mono tracking-wide">{studentId}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                    <p class="text-lg font-medium text-gray-900">{email}</p>
                </div>
            </div>

            <!-- Full Name (Updated to include Middle Name) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">First Name</label>
                    <p class="text-lg font-medium text-gray-900 capitalize">{firstName}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Middle Name</label>
                    <p class="text-lg font-medium text-gray-900 capitalize">{middleName}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Last Name</label>
                    <p class="text-lg font-medium text-gray-900 capitalize">{lastName}</p>
                </div>
            </div>

            <!-- Academic Info -->
            <div class="pt-4 border-t border-gray-100">
                <h2 class="text-sm font-bold text-plm-gold uppercase mb-4 tracking-wider">Academic Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Course</label>
                        <p class="text-lg font-medium text-plm-navy">{courseCode}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Year Level</label>
                        <p class="text-lg font-medium text-gray-900">{yearLevel}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Student Type</label>
                        <p class="text-lg font-medium text-gray-900 uppercase">{studentType}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Level</label>
                        <p class="text-lg font-medium text-gray-900 uppercase">{educationLevel}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
</body>
</html>