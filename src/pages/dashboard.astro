---
import "../styles/global.css";
import Header from "../components/Header.astro";

// --- NAVIGATION COMPONENTS ---
import StudentNavigation from "../components/navigations/StudentNavigation.astro";
import AdminNavigation from "../components/navigations/AdminNavigation.astro";
//import ProfessorTopNav from "../components/navigations/ProfessorTopNav.astro";

// --- DASHBOARD VIEWS ---
import StudentDashboard from "../components/dashboards/StudentDashboard.astro";
import AdminDashboard from "../components/dashboards/AdminDashboard.astro";
import ProfessorDashboard from "../components/dashboards/ProfessorDashboard.astro";

import type { Role, EnrollmentOfferingResponse, AdminEnrollmentDetailResponse } from "../types/api";

// --- 1. SERVER-SIDE AUTH GUARD ---
const tokenCookie = Astro.cookies.get('jwt_token');
const token = tokenCookie?.value;

if (!token) {
    return Astro.redirect('/');
}

// --- 2. GET USER CONTEXT ---
const roleCookie = Astro.cookies.get('user_role');
const currentRole = (roleCookie?.value || 'STUDENT') as Role;

// Hydrate profile from cookie
let userProfile: any = {};
try {
    const profileCookie = Astro.cookies.get('user_profile');
    if (profileCookie?.value) {
        userProfile = JSON.parse(atob(profileCookie.value));
    }
} catch (e) {
    console.error("Failed to parse profile cookie");
}

// --- ROBUST NAME PARSING (Fixes USER, USER issue) ---
let firstName = "";
let lastName = "";

// Check for composite name (Student/Admin often have this)
const fullName = userProfile.student_name || userProfile.name || userProfile.professor_name;

if (fullName && fullName.includes(',')) {
    // Format: "Lastname, Firstname M."
    const parts = fullName.split(',');
    lastName = parts[0].trim(); // "Lastname"

    // Handle First Name + potential Middle Initial
    const rest = parts[1].trim(); // "Firstname M."
    const nameParts = rest.split(' ');

    // Heuristic: If last part ends in dot or is single letter, it's likely Middle Initial
    if (nameParts.length > 1 && (nameParts[nameParts.length-1].endsWith('.') || nameParts[nameParts.length-1].length === 1)) {
        // Remove Middle Initial for the "First Name" display
        nameParts.pop();
        firstName = nameParts.join(' ');
    } else {
        firstName = rest;
    }
} else {
    // Fallback to explicit fields or defaults
    firstName = userProfile.firstName || userProfile.first_name || "User";
    lastName = userProfile.lastName || userProfile.last_name || "User";
}

// Determine the correct ID to display based on role
let displayId = "N/A";
if (currentRole === 'STUDENT') {
    displayId = userProfile.studentNo || userProfile.student_no || "N/A";
} else if (currentRole === 'PROFESSOR') {
    displayId = userProfile.professorId || userProfile.professor_id || "N/A";
} else if (currentRole === 'ADMIN') {
    displayId = "ADMIN";
}

// --- 3. DATA FETCHING ---
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || "http://localhost:8080";
let dashboardData: any = null;
let fetchError = null;

try {
    let endpoint = "";
    if (currentRole === 'STUDENT') endpoint = `${API_BASE}/api/enrollment/options`;
    else if (currentRole === 'ADMIN') endpoint = `${API_BASE}/api/admin/enrollments/pending`;

    if (endpoint) {
        const response = await fetch(endpoint, {
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });

        if (response.ok) {
            const json = await response.json();
            if (json.success) dashboardData = json.data;
        } else {
            console.warn(`Backend Error ${response.status}:`, await response.text());
        }
    }
} catch (e) {
    console.error("Backend unreachable:", e);
    fetchError = "Could not connect to server.";
}

if (!dashboardData && currentRole === 'ADMIN') dashboardData = [];

// --- 4. STUDENT LINKS (Still passed as props) ---
const studentLinks = [
    { label: "Home", href: "/dashboard" },
    { label: "Schedule", href: "/student/schedule" },
    { label: "Grades", href: "/student/grades" },
    { label: "Enrollment", href: "/student/enrollment" },
];

// Helper to count pending items for Admin Badge
const adminPendingCount = currentRole === 'ADMIN' && Array.isArray(dashboardData) ? dashboardData.length : 0;
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {currentRole}</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans text-gray-800">

<!-- Pass the correctly mapped variables to Header -->
<Header
        firstName={firstName}
        lastName={lastName}
        studentId={displayId.toString()}
/>

<!-- ROLE-BASED NAVIGATION SWITCHER -->
{currentRole === 'STUDENT' && <StudentNavigation links={studentLinks} />}
{currentRole === 'ADMIN' && <AdminNavigation pendingCount={adminPendingCount} />}
<!-- {currentRole === 'PROFESSOR' && <ProfessorTopNav />} -->

<main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-8">

    {fetchError && (
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                <span>{fetchError}</span>
            </div>
    )}

    {currentRole === 'STUDENT' && dashboardData && (
            <StudentDashboard
                    data={dashboardData}
                    studentName={`${firstName} ${lastName}`}
            />
    )}

    {currentRole === 'ADMIN' && (
            <AdminDashboard
                    pendingEnrollments={Array.isArray(dashboardData) ? dashboardData : []}
            />
    )}

    {currentRole === 'PROFESSOR' && (
            <ProfessorDashboard
                    professorName={`${firstName} ${lastName}`}
                    department={userProfile.department || "Faculty Department"}
            />
    )}
</main>
</body>
</html>