---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css"; // Assuming this handles your Tailwind setup

// --- NOTE: EnrollmentTable is not imported here because we render its HTML string client-side ---
---

<Layout>
    <div class="w-full max-w-7xl p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-900">Enrollment Portal</h1>
            <button id="logoutBtn" class="text-red-600 font-bold hover:underline">Logout</button>
        </div>

        <div id="loading-spinner" class="text-center py-12 text-gray-500">
            Loading Enrollment Data...
        </div>

        <div id="enrollment-portal-wrapper" class="hidden">

            <div id="enrollment-status-card" class="flex justify-center mb-4"></div>

            <div id="interactive-enrollment-content"></div>

            <div class="w-full bg-[#7F1D1D] text-white py-3 px-6 flex justify-between items-center shadow-md mt-0 rounded-b-md">
                <span class="font-bold text-sm">
                    Total Units Selected: <span id="units-selected" class="text-lg ml-2 font-mono font-bold">0</span>
                </span>
                <button id="submit-enrollment" class="bg-blue-900 text-white font-bold py-2 px-6 rounded hover:bg-blue-800 transition">
                    Submit Draft Enrollment
                </button>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { apiRequest } from "../lib/api.ts";

    // --- STATE ---
    let selectedSectionIds = new Set(); // Stores sectionNo (number)
    let availableSectionsData = [];    // Stores the fetched SectionDTO objects

    // --- UTILITIES (Pulled from EnrollmentTable styling) ---
    const statusColor = (status) => {
        switch (status) {
            case 'OPEN': return 'text-green-600 font-bold';
            case 'FULL': return 'text-red-600 font-bold';
            default: return 'text-gray-500';
        }
    }
    const enrollmentStatusColor = (status) => {
        switch (status) {
            case 'ENROLLED': return 'text-green-700 bg-green-100 border-green-300';
            case 'DRAFT': return 'text-yellow-700 bg-yellow-100 border-yellow-300';
            case 'REJECTED': return 'text-red-700 bg-red-100 border-red-300';
            default: return 'text-gray-700 bg-gray-100 border-gray-300';
        }
    }

    // --- 1. RENDER LOGIC (Generates HTML for the table) ---

    function generateInteractiveTableHTML(data) {
        const sections = data.sections || [];
        const tableRows = sections.map((sec, index) => {
            const isOpen = sec.status === 'OPEN';

            return `
            <tr class="border-b border-plm-gold/30 hover:bg-gray-50 transition-colors ${!isOpen ? 'opacity-60 bg-gray-100' : ''}">
                <td class="py-2 px-3 border-r border-plm-gold/50 text-center">
                    <input type="checkbox" 
                        class="enrollment-checkbox w-4 h-4 text-plm-navy rounded border-gray-300 focus:ring-plm-navy cursor-pointer"
                        value="${sec.sectionNo}" 
                        data-units="${sec.units}"
                        ${!isOpen ? 'disabled' : ''} />
                </td>
                <td class="py-2 px-3 border-r border-plm-gold/50 font-bold">${sec.subjectCode}</td>
                <td class="py-2 px-3 border-r border-plm-gold/50 uppercase font-medium">
                    ${sec.subjectTitle}
                    <div class="text-xs text-gray-500 font-normal">(${sec.sectionName})</div>
                </td>
                <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">${sec.units}</td>
                <td class="py-2 px-3 border-r border-plm-gold/50 text-xs">${sec.schedule}</td>
                <td class="py-2 px-3 ${statusColor(sec.status)} text-xs font-bold">${sec.status}</td>
            </tr>
            `;
        }).join('');

        return `
            <h2 class="text-lg font-bold text-plm-navy mb-2 uppercase border-b-2 border-plm-gold inline-block pb-1">
                ${data.termName || 'Loading Term'} - Select Sections
            </h2>
            <div class="overflow-x-auto border border-plm-gold shadow-sm">
                <table class="w-full text-sm text-left">
                    <thead class="bg-[#7F1D1D] text-white uppercase text-xs font-bold">
                        <tr>
                            <th class="py-2.5 px-3 border-r border-[#B8860B] w-10 text-center">#</th>
                            <th class="py-2.5 px-3 border-r border-[#B8860B] w-24">Subject Code</th>
                            <th class="py-2.5 px-3 border-r border-[#B8860B]">Description (Section)</th>
                            <th class="py-2.5 px-3 border-r border-[#B8860B] w-16 text-center">Units</th>
                            <th class="py-2.5 px-3 border-r border-[#B8860B]">Schedule</th>
                            <th class="py-2.5 px-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="interactive-tbody">${tableRows}</tbody>
                </table>
            </div>
        `;
    }

    function generateStatusCardHTML(data) {
        return `
            <div class="flex justify-center mb-4">
                <div class="text-sm py-2 px-4 rounded-lg border-2 shadow-md ${enrollmentStatusColor(data.enrollmentStatus)}">
                    <span class="font-bold">Current Status:</span> 
                    <span class="uppercase">${data.enrollmentStatus || 'NONE'}</span>
                    ${data.remarks ? `<span class="block text-xs italic opacity-80 mt-1">Remarks: ${data.remarks}</span>` : ''}
                </div>
            </div>
        `;
    }

    // --- 2. FETCH & INITIALIZE ---
    async function loadData() {
        const portalWrapper = document.getElementById('enrollment-portal-wrapper');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusCard = document.getElementById('enrollment-status-card');
        const contentWrapper = document.getElementById('interactive-enrollment-content');

        if (loadingSpinner) loadingSpinner.classList.remove('hidden');

        try {
            const data = await apiRequest("/enrollment/options", "GET");
            availableSectionsData = data.sections || [];

            // 1. Render Status Card
            if (statusCard) statusCard.innerHTML = generateStatusCardHTML(data);

            // 2. Render Interactive Table
            if (contentWrapper) contentWrapper.innerHTML = generateInteractiveTableHTML(data);

            // 3. Attach Listeners to the newly injected HTML
            attachEnrollmentListeners();

        } catch (e) {
            console.error("Dashboard Load Error:", e);
            if(contentWrapper) contentWrapper.innerHTML = `<p class="text-red-600 font-bold py-12 text-center">Error fetching data. Check console for API errors.</p>`;
        } finally {
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
            if (portalWrapper) portalWrapper.classList.remove('hidden');
        }
    }

    // --- 3. INTERACTIVITY & SUBMISSION ---

    function attachEnrollmentListeners() {
        const unitsSelectedDisplay = document.getElementById('units-selected');

        // 1. Checkbox listener for adding/removing sections
        document.querySelectorAll('.enrollment-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const target = e.target;
                const sectionId = parseInt(target.value);

                if (target.checked) {
                    selectedSectionIds.add(sectionId);
                } else {
                    selectedSectionIds.delete(sectionId);
                }

                // Recalculate and display total units
                let currentTotalUnits = 0;
                document.querySelectorAll('.enrollment-checkbox:checked').forEach(checkedBox => {
                    currentTotalUnits += parseInt(checkedBox.getAttribute('data-units') || '0');
                });
                if (unitsSelectedDisplay) unitsSelectedDisplay.textContent = currentTotalUnits.toString();
            });
        });

        // 2. Submission Button Listener
        document.getElementById('submit-enrollment')?.addEventListener('click', async () => {
            if (selectedSectionIds.size === 0) {
                alert("Please select at least one section.");
                return;
            }

            const submissionData = {
                // Convert the Set of numbers to an array of Longs for the backend DTO
                sectionIds: Array.from(selectedSectionIds).map(id => Number(id))
            };

            console.log("Submitting enrollment:", submissionData);

            try {
                // POST to the backend endpoint: /api/enrollment/submit
                const response = await apiRequest("/enrollment/submit", "POST", submissionData);

                // Success handler
                alert(`Success! ${response.message}. The page will now reload.`);
                window.location.reload();

            } catch (error) {
                console.error("Submission failed:", error);
                alert(`Submission Failed: ${error.message}`);
            }
        });
    }

    // --- 4. LOGOUT ---
    document.getElementById("logoutBtn")?.addEventListener("click", () => {
        localStorage.removeItem("jwt_token");
        localStorage.removeItem("user_profile");
        window.location.href = "/login";
    });

    // START APPLICATION
    loadData();
</script>