---
import ManagementTable from "../ManagementTable.astro";
import ManagementSearch from "../ManagementSearch.astro";
import SubjectModal from "../modals/SubjectModal.astro";

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || "http://localhost:8080";
const token = Astro.cookies.get('jwt_token')?.value;

const query = Astro.url.searchParams.get('q') || '';
const page = parseInt(Astro.url.searchParams.get('page') || '0');
const size = 10;

let subjectsData = [];
let totalPages = 0;
let error = null;

if (token) {
    try {
        const res = await fetch(`${API_BASE}/api/admin/subjects?q=${query}&page=${page}&size=${size}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            const json = await res.json();
            if (json.success && json.data) {
                subjectsData = json.data.content || [];
                totalPages = json.data.totalPages || 0;
            }
        } else {
            error = `Failed to load subjects (Status: ${res.status})`;
        }
    } catch (e) {
        console.error(e);
        error = "Could not connect to backend.";
    }
}
---

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-gray-800 font-garamond">Subject Management</h2>
        <ManagementSearch placeholder="Search subjects..." currentQuery={query} />
    </div>

    {error && <div class="p-4 bg-red-50 text-red-700 rounded-lg text-sm border border-red-200">Error: {error}</div>}

    <ManagementTable
            title="All Subjects"
            columns={['Subject Code', 'Subject Name', 'Lec Units', 'Lab Units']}
            rows={subjectsData}
            idKey="subject_code"
            createLabel="New Subject"
            onCreateClick="openCreateSubjectModal()"
            onEditClick="openEditSubjectModal"
            onDeleteClick="deleteSubject"

            currentPage={page}
            totalPages={totalPages}
            currentQuery={query}
            baseUrl="?role=ADMIN&view=subjects"
    />

    <SubjectModal />
</div>

<script>
    const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || "http://localhost:8080";

    function getToken() {
        const match = document.cookie.match(new RegExp('(^| )jwt_token=([^;]+)'));
        if (match) return match[2];
        return null;
    }

    // --- DYNAMIC COURSE LOADING FOR MODAL ---
    async function loadCourses() {
        const token = getToken();
        if (!token) return;
        try {
            const res = await fetch(`${API_BASE}/api/admin/courses`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();
            if (json.success && Array.isArray(json.data)) {
                const courseSelect = document.getElementById('modal-course');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">-- General Subject --</option>';
                    json.data.forEach((course) => {
                        const option = document.createElement('option');
                        option.value = course.courseCode || course.course_code;
                        option.textContent = `${course.courseCode || course.course_code} - ${course.courseName || course.course_name}`;
                        courseSelect.appendChild(option);
                    });
                }
            }
        } catch (e) {
            console.error("Failed to load courses", e);
        }
    }

    // --- DELETE LOGIC ---
    // @ts-ignore
    window.deleteSubject = async function(subjectCode) {
        if (!confirm(`Are you sure you want to delete subject "${subjectCode}"? This cannot be undone.`)) return;

        const token = getToken();
        if (!token) { alert("Session expired."); return; }

        try {
            const res = await fetch(`${API_BASE}/api/admin/subjects/${subjectCode}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();

            if (json.success) {
                alert("Subject deleted successfully.");
                location.reload();
            } else {
                alert("Error: " + (json.message || "Failed to delete subject"));
            }
        } catch (e) {
            console.error(e);
            alert("Network error.");
        }
    };

    document.addEventListener('DOMContentLoaded', loadCourses);
</script>